---
title: "Estimating Mixed Logit Models"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimating Mixed Logit Models}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
bibliography: "`r here::here('vignettes', 'library.bib')`"
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.retina = 3,
  comment = "#>"
)
library(logitr)
# Read in results from already estimated models  so that the
# examples aren't actually run when building this page, otherwise it'll
# take much longer to build
mxl_pref <- readRDS(here::here('inst', 'extdata', 'mxl_pref.Rds'))
mxl_wtp  <- readRDS(here::here('inst', 'extdata', 'mxl_wtp.Rds'))
```

This vignette demonstrates an example of how to use the `logitr()` function to estimate mixed logit (MXL) models with preference space and WTP space utility parameterizations.

# The data

```{r, child=here::here('man', 'rmdchunks', 'yogurtDataDescription.Rmd')}
```

In the utility models described below, the data variables are represented as follows:

```{r, child=here::here('man', 'rmdchunks', 'mnlPrefExampleTable.Rmd')}
```

# Preference space model

This example will estimate the following mixed logit model in the preference space:

```{r, child=here::here('man', 'rmdchunks', 'mnlPrefExample.Rmd')}
```

where the parameters $\alpha$, $\beta_1$, $\beta_2$, $\beta_3$, and $\beta_4$ have units of utility. In the example below, we will model $\beta_1$, $\beta_2$, $\beta_3$, and $\beta_4$ as normally distributed across the population. As a result, the model will estimate two parameters for each of these coefficients: a mean (`par_mu`) and a standard deviation (`par_sigma`).

Estimate the model using the `logitr()` function:

```{r eval=FALSE}
library("logitr")

mxl_pref <- logitr(
  data     = yogurt,
  choice   = 'choice',
  obsID    = 'obsID',
  pars     = c('price', 'feat', 'brand'),
  randPars = c(feat = 'n', brand = 'n'),
  # You should run a multistart for MXL models since they are non-convex
  numMultiStarts = 10
)
```
```
#> Running multistart...
#>   Iterations: 10
#>   Cores: 3
#> Done!
```

Print a summary of the results:

```{r}
summary(mxl_pref)
```

The above summary table prints summaries of the estimated coefficients as well as a summary table of the distribution of 10,000 population draws for each normally-distributed model coefficient. The results show that the `feat` attribute has a significant standard deviation coefficient, suggesting that there is considerable heterogeneity across the population for this attribute. In contrast, the `brand` coefficients have small and insignificant standard deviation coefficients.

Compute the WTP implied from the preference space model:

```{r}
wtp_mxl_pref <- wtp(mxl_pref, price =  "price")
wtp_mxl_pref
```

# WTP space model

This example will estimate the following mixed logit model in the WTP space:

```{r, child=here::here('man', 'rmdchunks', 'mnlWtpExample.Rmd')}
```

where the parameters $\omega_1$, $\omega_2$, $\omega_3$, and $\omega_4$ have units of dollars and $\lambda$ is the scale parameter. In the example below, we will model $\omega_1$, $\omega_2$, $\omega_3$, and $\omega_4$ as normally distributed across the population. As a result, the model will estimate two parameters for each of these coefficients: a mean (`par_mu`) and a standard deviation (`par_sigma`).

Estimate the model using the `logitr()` function:

```{r eval=FALSE}
mxl_wtp <- logitr(
  data       = yogurt,
  choice     = 'choice',
  obsID      = 'obsID',
  pars       = c('feat', 'brand'),
  price      = 'price',
  randPars   = c(feat = 'n', brand = 'n'),
  modelSpace = 'wtp',
  # You should run a multistart for MXL models since they are non-convex
  numMultiStarts = 10,
  # Use the computed WTP from the preference space model as the starting
  # values for the first run:
  startVals = wtp_mxl_pref$Estimate
)
```
```
#> Running multistart...
#>   Iterations: 10
#>   Cores: 3
#>   NOTE: Using user-provided starting values for first iteration
#> Done!
```

Print a summary of the results:

```{r}
summary(mxl_wtp)
```

If you want to compare the WTP from the two different model spaces, use the `wtpCompare()` function:

```{r}
wtpCompare(mxl_pref, mxl_wtp, price = 'price')
```

Note that the WTP will not necessarily be the same between preference space and WTP space MXL models. This is because the distributional assumptions in MXL models imply different distributions on WTP depending on the model space. See Train and Weeks [-@Train2005] and Sonnier, Ainslie, and Otter [-@Sonnier2007] for details on this topic.

# References
