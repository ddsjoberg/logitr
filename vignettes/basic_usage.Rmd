---
title: "Basic Usage"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Basic Usage}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.retina = 3,
  comment = "#>"
)
library(logitr)
# Read in results from already estimated models  so that the
# examples aren't actually run when building this page, otherwise it'll
# take much longer to build
mnl_pref <- readRDS(here::here('inst', 'extdata', 'mnl_pref.Rds'))
mnl_wtp  <- readRDS(here::here('inst', 'extdata', 'mnl_wtp.Rds'))
```

```{r, child=here::here('man', 'rmdchunks', 'header.Rmd')}
```

## Data format

```{r, child=here::here('man', 'rmdchunks', 'dataFormat.Rmd')}
```

The ["Data Formatting and Encoding"](data_formatting.html) vignette has more details about the required data format.

## Model specification interface

Models are specified and estimated using the `logitr()` function. The `data` argument should be set to the data frame containing the choice data, and the `choice` and `obsID` arguments should be set to the column names in the data frame that correspond to the choice dummy variable column and the observation ID column, respectively. All variables to be used as model covariates should be provided as a vector of column names to the `pars` argument. Each variable in the vector is additively included as a covariate in the utility model, with the interpretation that they represent utilities in preference space models and WTPs in a WTP space model.

For example, consider a preference space model where the utility for yogurt is given by the following utility model:

```{r, child=here::here('man', 'rmdchunks', 'yogurtUtilityPref.Rmd')}
```

\noindent
where $p_{j}$ is `price`, $x_{j1}$ is `feat`, and $x_{j2-4}$ are dummy-coded variables for each `brand` (with the fourth brand representing the reference level). This model can be estimated using the `logitr()` function as follows:

```{r, eval=FALSE}
mnl_pref <- logitr(
    data   = yogurt,
    choice = "choice",
    obsID  = "obsID",
    pars   = c("price", "feat", "brand")
)
```

The equivalent model in the WTP space is given by the following utility model:

```{r, child=here::here('man', 'rmdchunks', 'yogurtUtilityWtp.Rmd')}
```

\noindent
To specify this model, the user should move `"price"` from the `pars` argument to the `price` argument and set the `modelSpace` argument to `"wtp"` (`"pref"` is the default value):

```{r, eval=FALSE}
mnl_wtp <- logitr(
    data   = yogurt,
    choice = "choice",
    obsID  = "obsID",
    pars   = c("feat", "brand"),
    price  = "price",
    modelSpace = "wtp"
)
```

\noindent
In the above model, the variables in `pars` are marginal WTPs, whereas in the preference space model they are marginal utilities. Note that in the WTP space model price is separately specified with the `price` argument as it acts as a scaling term and does not reflect a marginal WTP.

Interactions between covariates can be entered in the `pars` vector separated by the `*` symbol. For example, an interaction between `price` with `feat` in the above preference space model could be included by specifying `pars = c("price", "feat", "brand", "price*feat")`, or even more concisely just `pars = c("price*feat", "brand")` as the interaction between `price` and `feat` will produce individual parameters for `price` and `feat` in addition to the interaction parameter.

Both of these examples are multinomial logit models with fixed parameters. See the ["Estimating Multinomial Logit Models"](mnl_models.html) vignette for more details.

## Multi-start estimation

Since WTP space models have non-convex log-likelihood functions, it is recommended to use a multi-start search to run the optimization loop multiple times to search for different local minima. This is implemented using the `numMultiStarts` argument, e.g.:

```{r}
mnl_wtp <- logitr(
    data   = yogurt,
    choice = "choice",
    obsID  = "obsID",
    pars   = c("feat", "brand"),
    price  = "price",
    modelSpace = "wtp",
    numMultiStarts = 10
)
```

## Viewing results

Use the `summary()` function to print a summary of the results from an estimated model, e.g.

```{r}
summary(mnl_pref)
```

Use `statusCodes()` to print a description of each status code from the `nloptr` optimization routine.

You can also extract other values of interest at the solution, such as:

**The estimated coefficients**

```{r}
coef(mnl_pref)
```

**The log-likelihood**

```{r}
logLik(mnl_pref)
```

**The variance-covariance matrix**

```{r}
vcov(mnl_pref)
```

**The coefficient standard errors**

```{r}
sqrt(diag(vcov(mnl_pref)))
```

## Computing and comparing WTP

For models in the preference space, a summary table of the computed WTP based on the estimated preference space parameters can be obtained with the `wtp()` function. For example, the computed WTP from the previously estimated fixed parameter model can be obtained with the following command:

```{r}
wtp(mnl_pref, price = "price")
```

The `wtp()` function divides the non-price parameters by the negative of the price parameter. Standard errors are estimated using the Krinsky and Robb parametric bootstrapping method [@Krinsky1986]. Similarly, the `wtpCompare()` function can be used to compare the WTP from a WTP space model with that computed from an equivalent preference space model:

```{r}
wtpCompare(mnl_pref, mnl_wtp, price = "price")
```

## Mixed logit models

To estimate a mixed logit model, use the `randPars` argument in the `logitr()` function to denote which parameters will be modeled with a distribution. The current package version supports normal (`"n"`) and log-normal (`"ln"`) distributions.

For example, assume the observed utility for yogurts was $v_{j} = \alpha p_{j} + \beta_1 x_{j1} + \beta_2 x_{j2} + \beta_3 x_{j3} + \beta_4 x_{j4}$, where $p_{j}$ is `price`, $x_{j1}$ is `feat`, and $x_{j2-4}$ are dummy-coded variables for `brand`. To model `feat` as well as each of the brands as normally-distributed, set `randPars = c(feat = "n", brand = "n")`:

```{r, eval=FALSE}
mxl_pref <- logitr(
    data     = yogurt,
    choice   = 'choice',
    obsID    = 'obsID',
    pars     = c('price', 'feat', 'brand'),
    randPars = c(feat = 'n', brand = 'n'),
    numMultiStarts = 10
)
```

Since mixed logit models also have non-convex log-likelihood functions, it is again recommended to use a multi-start search to run the optimization loop multiple times to search for different local minima.

See the ["Estimating Mixed Logit Models"](mxl_models.html) vignette for more details.

## Predicting choice probabilities

Estimated models can be used to predict expected choices and choice probabilities for a set (or multiple sets) of alternatives based on an estimated model. As an example, consider predicting choice probabilities for two of the choice observations from the `yogurt` dataset:

```{r}
alts <- subset(
  yogurt, obsID %in% c(42, 13),
  select = c('obsID', 'alt', 'choice', 'price', 'feat', 'brand')
)

alts
```

In the example below, the expected choice probabilities for these two sets of alternatives are computed using the fixed parameter `mnl_pref` model:

```{r}
probs <- predictProbs(
  model = mnl_pref,
  alts  = alts,
  altID = "alt",
  obsID = "obsID"
)

probs
```

The resulting `probs` data frame contains the expected choice probabilities for each alternative. The low and high values show a 95% confidence interval, estimated using the Krinsky and Robb parametric bootstrapping method [@Krinsky1986]. You can change the CI level with the optional `ci` argument (e.g. a 90% CI is obtained with `ci = 0.90`).

Choice probabilities can also be predicted used WTP space models. For example, the predicted choice probabilities using the `mnl_wtp` model are nearly identical with those from the `mnl_pref` model:

```{r}
probs <- predictProbs(
  model = mnl_wtp,
  alts  = alts,
  altID = "alt",
  obsID = "obsID"
)

probs
```

See the ["Predicting Choice Probabilities from Estimated Models"](predict_probs.html) vignette for more details.

## Predicting choices

Similar to the `predictProbs()` function, the `predictChoices()` function can be used to predict choices using the results of an estimated model. In the example below, choices are predicted for the entire `yogurt` dataset, which was used to the estimate the `mnl_pref` model:

```{r}
choices <- predictChoices(
  model = mnl_pref,
  alts  = yogurt,
  altID = "alt",
  obsID = "obsID"
)

# Preview actual and predicted choices
head(choices[c('obsID', 'choice', 'choice_predict')])
```

The resulting `choices` data frame contains the same `alts` data frame with an additional column, `choice_predict`, which contains the predicted choices. You can quickly compute the accuracy by dividing the number of correctly predicted choices by the total number of choices:

```{r}
chosen <- subset(choices, choice == 1)
chosen$correct <- chosen$choice == chosen$choice_predict
sum(chosen$correct) / nrow(chosen)
```

See the ["Predicting Choices from Estimated Models"](predict_choices.html) vignette for more details.
